# Vision-Agents 통합 시스템 개황

**버전**: 1.0  
**작성일**: 2026-01-21  
**작성자**: AI Assistant

---

## 목차

1. [시스템 개요](#1-시스템-개요)
2. [전체 아키텍처](#2-전체-아키텍처)
3. [데이터 플로우](#3-데이터-플로우)
4. [기능 정의](#4-기능-정의)
5. [기술 스택](#5-기술-스택)
6. [성능 지표](#6-성능-지표)

---

## 1. 시스템 개요

### 1.1 목적

Vision-Agents의 Security Camera Example을 참고하여 현재 AI_CCTV_final 프로젝트를 개선:

1. **이벤트 기반 아키텍처** 도입으로 확장성 및 유지보수성 향상
2. **Function Calling** 시스템으로 자연어 인터페이스 제공
3. **패키지 감지 및 도난 감지** 기능 추가
4. **음성 인터랙션** 기능 추가 (선택)
5. **데이터베이스** 통합으로 이력 관리

### 1.2 핵심 원칙

- **점진적 통합**: 기존 시스템 유지하면서 단계적으로 개선
- **패턴 참고**: Vision-Agents 아키텍처 패턴 참고, 직접 의존성 최소화
- **호환성 유지**: 기존 VAD/VLM/Agent 시스템과의 호환성 보장
- **선택적 적용**: 필요한 기능만 선별적으로 적용

### 1.3 통합 범위

**포함:**
- ✅ 이벤트 기반 아키텍처
- ✅ Function Calling 시스템
- ✅ 패키지 감지 (YOLO v12 nano, 커스텀 학습 불필요)
- ✅ 도난 감지 로직 (3초 확인)
- ✅ SQLite 데이터베이스
- ✅ 음성 인터랙션 (선택, Agent와 연동 시)

**제외:**
- ❌ 얼굴 인식 기능 (불필요)
- ❌ Vision-Agents Agent 클래스 직접 사용
- ❌ GetStream Edge 필수 사용 (선택 사항, 무료 티어 있음)

---

## 2. 전체 아키텍처

### 2.1 통합 후 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        USER INTERFACE LAYER                               │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                │
│  │   CLI UI    │    │ Streamlit   │    │  React UI   │                │
│  │   (Rich)    │    │   Web UI    │    │             │                │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘                │
└─────────┼───────────────────┼───────────────────┼──────────────────────┘
          │                   │                   │
          └───────────────────┼───────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    E2E SYSTEM ENGINE (개선됨)                             │
│                  app/e2e_system.py + Event System                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                    EVENT BUS (신규)                                  │ │
│  │  ┌──────────────────────────────────────────────────────────────┐ │ │
│  │  │  Event Types:                                                 │ │ │
│  │  │  - AnomalyDetectedEvent                                       │ │ │
│  │  │  - VLMAnalysisCompletedEvent                                  │ │ │
│  │  │  - AgentResponseEvent                                         │ │ │
│  │  │  - PackageDetectedEvent                                        │ │ │
│  │  │  - PackageDisappearedEvent                                     │ │ │
│  │  │  - TheftDetectedEvent                                          │ │ │
│  │  │  - FrameProcessedEvent                                         │ │ │
│  │  │  - StatsUpdatedEvent                                           │ │ │
│  │  └──────────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                              │                                             │
│                              ▼                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                    VIDEO INPUT LAYER                                │ │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐           │ │
│  │  │ Video File  │    │ RTSP Stream │    │   Webcam    │           │ │
│  │  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘           │ │
│  │         └──────────────────┼──────────────────┘                  │ │
│  │                              ▼                                     │ │
│  │                   ┌─────────────────┐                             │ │
│  │                   │  VideoSource    │                             │ │
│  │                   └────────┬────────┘                             │ │
│  └────────────────────────────┼──────────────────────────────────────┘ │
│                               ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                    PROCESSING PIPELINE                              │ │
│  │                                                                      │ │
│  │  ┌─────────────┐                                                    │ │
│  │  │Frame Buffer │                                                    │ │
│  │  │(16 frames)  │                                                    │ │
│  │  └──────┬──────┘                                                    │ │
│  │         │                                                            │ │
│  │         ├─▶ VAD Model (MNAD)                                        │ │
│  │         │   └─▶ AnomalyDetectedEvent 발행                           │ │
│  │         │                                                            │ │
│  │         ├─▶ Package Detector (YOLO v12 nano) [신규]                │ │
│  │         │   └─▶ PackageDetectedEvent 발행                           │ │
│  │         │                                                            │ │
│  │         └─▶ Clip Saver (3초 저장)                                   │ │
│  │             └─▶ VLMAnalysisCompletedEvent 발행                     │ │
│  │                 └─▶ AgentResponseEvent 발행                         │ │
│  │                                                                      │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                    FUNCTION CALLING SYSTEM (신규)                    │ │
│  │  ┌──────────────────────────────────────────────────────────────┐ │ │
│  │  │  Function Registry:                                            │ │ │
│  │  │  - get_system_status()                                          │ │ │
│  │  │  - get_recent_events(limit)                                     │ │ │
│  │  │  - get_anomaly_statistics()                                     │ │ │
│  │  │  - get_package_count()                                          │ │ │
│  │  │  - get_package_details()                                        │ │ │
│  │  │  - update_vad_threshold(value)                                  │ │ │
│  │  │  - enable_vlm(enabled)                                          │ │ │
│  │  │  - set_agent_flow(flow_type)                                   │ │ │
│  │  └──────────────────────────────────────────────────────────────┘ │ │
│  │                              │                                     │ │
│  │                              ▼                                     │ │
│  │                   ┌─────────────────────┐                         │ │
│  │                   │  Agent System       │                         │ │
│  │                   │  (Qwen3-8B)         │                         │ │
│  │                   │  + Function Calling │                         │ │
│  │                   └─────────────────────┘                         │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                    VOICE INTERACTION (선택, 신규)                     │ │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐           │ │
│  │  │     STT     │───▶│  Function    │───▶│     TTS     │           │ │
│  │  │ (Deepgram)  │    │  Calling     │    │(ElevenLabs) │           │ │
│  │  └─────────────┘    └─────────────┘    └─────────────┘           │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                    DATABASE LAYER (신규)                             │ │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐           │ │
│  │  │   SQLite    │    │   Events    │    │  Packages   │           │ │
│  │  │  Database   │    │   Table     │    │   Table     │           │ │
│  │  └─────────────┘    └─────────────┘    └─────────────┘           │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                    OUTPUT LAYER                                       │ │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐           │ │
│  │  │ Event Logger│    │ Clip Storage│    │  Statistics │           │ │
│  │  │ (JSON/DB)   │    │ (MP4)       │    │  (Metrics)  │           │ │
│  │  └─────────────┘    └─────────────┘    └─────────────┘           │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────────────────────────┘
```

### 2.2 컴포넌트 상세

#### 2.2.1 Event Bus (신규)

**역할**: 중앙 집중식 이벤트 관리

**구현 위치**: `src/utils/event_bus.py`

**주요 기능:**
- 이벤트 발행 (publish)
- 이벤트 구독 (subscribe)
- 이벤트 필터링
- 이벤트 히스토리 관리

#### 2.2.2 Function Calling System (신규)

**역할**: 자연어로 시스템 제어

**구현 위치**: `src/agent/function_calling.py`

**주요 기능:**
- 함수 등록 및 관리
- LLM과의 통합
- 함수 실행 엔진
- 에러 처리

#### 2.2.3 Package Detector (신규)

**역할**: YOLO v12 nano 기반 패키지 감지

**구현 위치**: `src/pipeline/package_detector.py`

**주요 기능:**
- 패키지 객체 감지
- 패키지 추적
- 도난 감지 로직 (3초 확인)

#### 2.2.4 Voice Interaction (선택, 신규)

**역할**: 음성 기반 질의응답

**구현 위치**: `src/utils/voice_interaction.py`

**주요 기능:**
- STT (Deepgram)
- TTS (ElevenLabs)
- 음성 → Function Calling → 음성

#### 2.2.5 Database Layer (신규)

**역할**: 이벤트 및 패키지 이력 저장

**구현 위치**: `src/database/`

**주요 기능:**
- SQLite 데이터베이스
- 이벤트 저장
- 패키지 이력 저장
- 통계 조회

---

## 3. 데이터 플로우

### 3.1 정상 상황 플로우

```
Frame (비디오 입력)
    │
    ├─▶ VAD Model (MNAD)
    │   └─▶ Score: 0.3 (< threshold)
    │       └─▶ FrameProcessedEvent 발행
    │           └─▶ UI 업데이트 (녹색 표시)
    │
    ├─▶ Package Detector (YOLO v12 nano)
    │   └─▶ 패키지 없음
    │       └─▶ 계속 처리
    │
    └─▶ Frame Buffer 업데이트
```

### 3.2 이상 상황 플로우 (VAD 기반)

```
Frame
    │
    ├─▶ VAD Model (MNAD)
    │   └─▶ Score: 0.7 (>= threshold)
    │       └─▶ AnomalyDetectedEvent 발행
    │           │
    │           ├─▶ Clip Saver 시작 (3초 저장)
    │           │
    │           ├─▶ Event Bus에 이벤트 전달
    │           │   └─▶ 구독자들에게 알림
    │           │
    │           └─▶ UI 업데이트 (빨간색 경고)
    │
    └─▶ Clip 저장 완료
        │
        ├─▶ VLM Analyzer (Qwen2.5-VL)
        │   └─▶ 분석 결과: "Fighting"
        │       └─▶ VLMAnalysisCompletedEvent 발행
        │
        ├─▶ Agent System (Qwen3-8B)
        │   └─▶ 대응 계획: ["보안요원 출동", "경찰 신고"]
        │       └─▶ AgentResponseEvent 발행
        │
        └─▶ Event Logger
            └─▶ 데이터베이스 저장
```

### 3.3 패키지 감지 플로우 (신규)

```
Frame
    │
    ├─▶ Package Detector (YOLO v12 nano)
    │   └─▶ 패키지 감지 (confidence: 0.85)
    │       └─▶ PackageDetectedEvent 발행
    │           │
    │           ├─▶ 패키지 ID 할당
    │           ├─▶ 데이터베이스 저장
    │           ├─▶ 위치 추적 시작
    │           └─▶ UI 업데이트
    │
    └─▶ 패키지 추적 중...
        │
        └─▶ 패키지 사라짐 감지
            └─▶ PackageDisappearedEvent 발행
                │
                ├─▶ 3초 대기 (delayed_theft_check)
                │   │
                │   ├─▶ 패키지 재등장?
                │   │   예: PackageDetectedEvent → 도난 확인 취소
                │   │
                │   └─▶ 패키지 여전히 없음?
                │       └─▶ TheftDetectedEvent 발행
                │           ├─▶ 데이터베이스 업데이트
                │           ├─▶ 알림 시스템 (선택)
                │           └─▶ UI 업데이트
```

### 3.4 Function Calling 플로우 (신규)

```
사용자 질의 (자연어 또는 음성)
    │
    ├─▶ STT (음성인 경우)
    │   └─▶ 텍스트 변환
    │
    ├─▶ Agent System (Qwen3-8B)
    │   └─▶ Function Calling 분석
    │       ├─▶ 필요한 함수 식별
    │       └─▶ 파라미터 추출
    │
    ├─▶ Function Registry
    │   └─▶ 함수 실행
    │       예: get_system_status()
    │       └─▶ 결과 반환
    │
    ├─▶ Agent System
    │   └─▶ 결과를 자연어로 변환
    │       └─▶ "시스템은 정상 작동 중이며..."
    │
    └─▶ TTS (음성인 경우)
        └─▶ 음성 응답
```

### 3.5 이벤트 기반 통합 플로우

```
이벤트 발행
    │
    ├─▶ Event Bus
    │   ├─▶ 이벤트 타입별 라우팅
    │   ├─▶ 구독자 목록 조회
    │   └─▶ 비동기 전달
    │
    ├─▶ 구독자 1: Event Logger
    │   └─▶ 데이터베이스 저장
    │
    ├─▶ 구독자 2: UI 업데이트
    │   └─▶ 실시간 대시보드 갱신
    │
    ├─▶ 구독자 3: 알림 시스템 (선택)
    │   └─▶ 이메일/웹훅 전송
    │
    └─▶ 구독자 N: 커스텀 핸들러
        └─▶ 사용자 정의 로직
```

---

## 4. 기능 정의

### 4.1 핵심 기능

#### 4.1.1 이상 탐지 (기존 + 개선)

**기능**: VAD 모델을 통한 실시간 이상 탐지

**입력**: 비디오 프레임 (RGB)

**출력**: 이상 점수 (0.0 ~ 1.0)

**이벤트**: `AnomalyDetectedEvent`

**개선 사항**:
- 이벤트 기반 아키텍처로 전환
- 이벤트 구독자에게 자동 알림

#### 4.1.2 상황 분석 (기존 + 개선)

**기능**: VLM을 통한 이상 상황 유형 분류 및 설명

**입력**: 이상 감지 클립 (3초)

**출력**: 
- `detected_type`: "Fighting", "Arson", etc.
- `description`: 상황 설명
- `actions`: 권장 대응

**이벤트**: `VLMAnalysisCompletedEvent`

#### 4.1.3 자동 대응 (기존 + 개선)

**기능**: Agent 시스템을 통한 대응 계획 수립 및 실행

**입력**: VLM 분석 결과

**출력**: 대응 계획 리스트

**이벤트**: `AgentResponseEvent`

**개선 사항**:
- Function Calling 통합
- 자연어 질의응답 지원

#### 4.1.4 패키지 감지 (신규)

**기능**: YOLO v12 nano를 통한 패키지 객체 감지 및 추적

**입력**: 비디오 프레임

**출력**: 
- 패키지 위치 (bbox)
- 패키지 ID
- 신뢰도

**이벤트**: `PackageDetectedEvent`, `PackageDisappearedEvent`

#### 4.1.5 도난 감지 (신규)

**기능**: 패키지 사라짐 시 도난 여부 판단

**로직**:
1. 패키지 사라짐 감지
2. 3초 대기
3. 재등장 여부 확인
4. 재등장 없으면 도난 판정

**이벤트**: `TheftDetectedEvent`

#### 4.1.6 Function Calling (신규)

**기능**: 자연어로 시스템 제어 및 조회

**지원 함수**:
- 시스템 상태 조회
- 최근 이벤트 조회
- 이상 탐지 통계
- 패키지 통계
- 시스템 설정 변경

**통합**: Agent System (Qwen3-8B)

#### 4.1.7 음성 인터랙션 (선택, 신규)

**기능**: 음성 기반 질의응답

**흐름**: 음성 → STT → Function Calling → TTS → 음성

**통합**: Agent System과 연동

### 4.2 보조 기능

#### 4.2.1 이벤트 로깅

**기능**: 모든 이벤트를 데이터베이스에 저장

**저장소**: SQLite

**형식**: JSON

#### 4.2.2 클립 저장

**기능**: 이상 감지 시 3초 클립 저장

**형식**: MP4

**위치**: `clips/` 디렉토리

#### 4.2.3 통계 수집

**기능**: 시스템 성능 및 사용량 통계

**지표**:
- 처리 FPS
- 이상 탐지 횟수
- 평균 처리 시간
- 패키지 감지 횟수

---

## 5. 기술 스택

### 5.1 기존 기술 스택

| 카테고리 | 기술 | 버전 |
|---------|------|------|
| VAD | MNAD, MULDE, MemAE, STAE, STEAD | - |
| VLM | Qwen2.5-VL-7B | GGUF |
| LLM | Qwen3-8B | GGUF |
| 비디오 처리 | OpenCV | 4.8+ |
| UI | Rich, Streamlit, React | - |
| Python | Python | 3.10+ |

### 5.2 추가 기술 스택

| 카테고리 | 기술 | 버전 | 용도 |
|---------|------|------|------|
| 객체 감지 | YOLO v12 nano | 최신 | 패키지 감지 |
| STT | Deepgram | 최신 | 음성 인식 (선택) |
| TTS | ElevenLabs | 최신 | 음성 합성 (선택) |
| 데이터베이스 | SQLite | 3.x | 이벤트/패키지 저장 |
| 이벤트 시스템 | 자체 구현 | - | 이벤트 버스 |

### 5.3 선택 기술 스택

| 카테고리 | 기술 | 용도 | 비고 |
|---------|------|------|------|
| 엣지 네트워크 | GetStream Edge | WebRTC 실시간 처리 | 선택 사항, 무료 티어 있음 |

---

## 6. 성능 지표

### 6.1 목표 성능

| 지표 | 현재 | 목표 | 측정 방법 |
|------|------|------|----------|
| VAD 처리 속도 | 265 FPS | 200+ FPS | 프레임 처리 시간 |
| 이벤트 처리 지연 | - | < 10ms | 이벤트 발행부터 구독자 처리까지 |
| Function Calling 응답 | - | < 2초 | 질의부터 응답까지 |
| 패키지 감지 처리 | - | < 100ms | 프레임 입력부터 감지 결과까지 |
| 전체 시스템 FPS | 30 FPS | 30+ FPS | VAD + 패키지 감지 |

### 6.2 리소스 사용

| 구성 | GPU 메모리 | CPU | RAM |
|------|-----------|-----|-----|
| VAD Only | 1GB | 10% | 2GB |
| VAD + Package Detector | 2GB | 15% | 3GB |
| VAD + VLM | 9GB | 30% | 4GB |
| VAD + VLM + Agent | 12GB | 40% | 6GB |
| 전체 (음성 포함) | 12GB | 50% | 8GB |

---

## 7. 통합 단계별 요약

### Phase 1: 이벤트 시스템 (1-2주) ✅ 시작
- Event Bus 구현
- 기존 콜백을 이벤트로 전환
- 이벤트 핸들러 구현

### Phase 2: Function Calling (1주)
- Function Registry 구현
- 핵심 함수 구현
- Agent와 통합

### Phase 3: 패키지 감지 (2주)
- YOLO v12 nano 통합 (커스텀 학습 불필요)
- 패키지 추적 시스템
- 도난 감지 로직 (3초 확인)

### Phase 4: 데이터베이스 (1주)
- SQLite 스키마 설계
- 이벤트 저장
- 패키지 이력 저장

### Phase 5: 음성 인터랙션 (선택, 1-2주)
- Agent와 연동되는 경우에만 구현
- STT/TTS 통합
- 음성 인터페이스 구현

---

*이 문서는 프로젝트 진행에 따라 지속적으로 업데이트됩니다.*
