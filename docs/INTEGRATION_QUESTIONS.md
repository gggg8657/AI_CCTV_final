# 통합 시스템 구축 - 확인 사항

**작성일**: 2025-01-21

---

## 🔍 현재 상태 분석

### ✅ 잘 구성된 부분
1. **E2ESystem**: 콜백 기반으로 잘 구조화됨
2. **AnomalyEvent**: 데이터 모델이 명확함
3. **EventLogger**: JSON 파일 저장 기능 있음
4. **multi_camera.py**: 기본 구조 존재

### ❓ 통합 시 확인 필요 사항

---

## 1. 데이터베이스 통합 방식

### 질문 1-1: 이벤트 저장 시점
**현재**: `EventLogger.log_event()`에서 JSON 파일로 저장  
**추가 필요**: 데이터베이스에도 저장

**선택지**:
- **A) 동기 저장**: 이벤트 발생 시 즉시 DB 저장 (안전하지만 느림)
- **B) 비동기 저장**: 큐에 넣고 백그라운드에서 저장 (빠르지만 복잡)
- **C) 배치 저장**: 일정 시간마다 모아서 저장 (균형)

**추천**: **C) 배치 저장** (1초마다 또는 10개씩 모아서)

### 질문 1-2: EventLogger 확장 vs 새 클래스
**선택지**:
- **A) EventLogger 확장**: `save_to_db()` 메서드 추가
- **B) DatabaseEventLogger 생성**: 별도 클래스, EventLogger와 조합

**추천**: **A) EventLogger 확장** (기존 코드 최소 변경)

---

## 2. 멀티 카메라 시스템 통합

### 질문 2-1: E2ESystem과 MultiCameraSystem 관계
**현재**: 
- `E2ESystem`: 단일 카메라 처리
- `MultiCameraSystem`: 다중 카메라 처리 (기본 구조만 있음)

**선택지**:
- **A) MultiCameraManager가 E2ESystem 인스턴스들을 관리**
  - 각 카메라마다 독립적인 E2ESystem 생성
  - 장점: 기존 코드 재사용, 독립적 처리
  - 단점: 리소스 중복 가능성
  
- **B) E2ESystem을 확장하여 멀티 카메라 지원**
  - E2ESystem 내부에서 여러 카메라 처리
  - 장점: 통합 관리
  - 단점: 기존 코드 대폭 수정 필요

**추천**: **A) MultiCameraManager가 E2ESystem 인스턴스들을 관리**

### 질문 2-2: 리소스 공유 전략
**질문**: VAD/VLM/Agent 모델을 카메라 간 공유할까요?

**선택지**:
- **A) 모델 공유**: 하나의 모델 인스턴스를 여러 카메라가 사용
  - 장점: 메모리 절약
  - 단점: 동시성 처리 필요 (락 필요)
  
- **B) 카메라별 독립 모델**: 각 카메라마다 모델 인스턴스 생성
  - 장점: 동시성 문제 없음, 독립적 처리
  - 단점: 메모리 사용량 증가

**추천**: **A) 모델 공유** (ResourcePool 사용)

---

## 3. API 서버 통합

### 질문 3-1: E2ESystem 인스턴스 관리
**질문**: API 서버에서 E2ESystem 인스턴스를 어떻게 관리할까요?

**선택지**:
- **A) 전역 싱글톤**: 하나의 MultiCameraManager 인스턴스
- **B) FastAPI Dependency**: 의존성 주입으로 관리
- **C) 별도 프로세스**: API 서버와 E2ESystem을 분리 (gRPC/메시지 큐)

**추천**: **B) FastAPI Dependency** (테스트 용이, 확장성 좋음)

### 질문 3-2: 비동기 처리
**질문**: E2ESystem의 `start()`는 블로킹입니다. API 서버에서 어떻게 처리할까요?

**선택지**:
- **A) 백그라운드 태스크**: FastAPI BackgroundTasks 사용
- **B) 별도 스레드**: threading.Thread로 실행
- **C) 별도 프로세스**: multiprocessing 사용

**추천**: **B) 별도 스레드** (간단하고 효과적)

---

## 4. 이벤트 스트리밍

### 질문 4-1: WebSocket 연결 관리
**질문**: 여러 클라이언트가 동시에 연결할 수 있도록 어떻게 관리할까요?

**선택지**:
- **A) 브로드캐스트**: 모든 연결된 클라이언트에 동일한 데이터 전송
- **B) 구독 기반**: 클라이언트가 특정 카메라만 구독
- **C) 혼합**: 기본은 브로드캐스트, 필요시 구독

**추천**: **B) 구독 기반** (효율적)

### 질문 4-2: 프레임 스트리밍 주기
**질문**: 얼마나 자주 프레임을 전송할까요?

**선택지**:
- **A) 모든 프레임**: 실시간 (네트워크 부하 큼)
- **B) 1초마다**: 1 FPS
- **C) 설정 가능**: 사용자가 선택 (1, 5, 10, 30 FPS)

**추천**: **C) 설정 가능** (기본값: 5 FPS)

---

## 5. 인증 및 권한

### 질문 5-1: 카메라 접근 권한 체크 시점
**질문**: 권한 체크를 어디서 할까요?

**선택지**:
- **A) API 레벨**: 각 엔드포인트에서 체크
- **B) 서비스 레벨**: 비즈니스 로직에서 체크
- **C) 데이터베이스 레벨**: 쿼리 시 자동 필터링

**추천**: **A) API 레벨** (명확하고 안전)

---

## 6. 알림 시스템

### 질문 6-1: 알림 발송 시점
**질문**: 이벤트 발생 시 즉시 알림을 보낼까요?

**선택지**:
- **A) 즉시 발송**: 이벤트 발생 즉시
- **B) 배치 발송**: 일정 시간마다 모아서
- **C) 우선순위 기반**: 중요도에 따라 즉시/배치

**추천**: **C) 우선순위 기반** (high/critical: 즉시, medium/low: 배치)

### 질문 6-2: 알림 중복 방지
**질문**: 같은 이벤트에 대해 여러 번 알림을 보내지 않도록 어떻게 할까요?

**선택지**:
- **A) 시간 윈도우**: 일정 시간(예: 5분) 내 중복 방지
- **B) 이벤트 그룹핑**: 유사한 이벤트를 그룹화
- **C) 사용자 설정**: 사용자가 중복 알림 허용 여부 설정

**추천**: **A) 시간 윈도우** (간단하고 효과적)

---

## 7. 성능 및 확장성

### 질문 7-1: 동시 처리 카메라 수 제한
**질문**: 최대 몇 개의 카메라를 동시에 처리할 수 있도록 설계할까요?

**현재 계획**: 16개

**확인 사항**:
- GPU 메모리로 충분한가?
- CPU 코어 수는 충분한가?
- 네트워크 대역폭은 충분한가?

### 질문 7-2: 수평 확장
**질문**: 나중에 여러 서버로 확장할 계획이 있나요?

**선택지**:
- **A) 단일 서버**: 현재는 단일 서버만 고려
- **B) 분산 처리**: 여러 서버에 카메라 분산 배치

**현재**: **A) 단일 서버** (Phase 2에서 분산 처리 고려)

---

## 8. 설정 관리

### 질문 8-1: 설정 저장 위치
**질문**: 카메라 설정을 어디에 저장할까요?

**선택지**:
- **A) 데이터베이스만**: DB에만 저장
- **B) 설정 파일 + DB**: 기본값은 파일, 사용자 변경은 DB
- **C) 환경 변수 + DB**: 배포 시 환경 변수, 런타임 변경은 DB

**추천**: **A) 데이터베이스만** (단순하고 일관성)

---

## 📋 결정 사항 요약

다음 사항들을 결정해주시면 구현을 시작하겠습니다:

1. **이벤트 저장 방식**: 배치 저장 (1초마다 또는 10개씩) ✅
2. **멀티 카메라 구조**: MultiCameraManager가 E2ESystem 인스턴스 관리 ✅
3. **모델 공유**: ResourcePool로 모델 공유 ✅
4. **API 서버 구조**: FastAPI Dependency로 관리 ✅
5. **WebSocket 구독**: 구독 기반, 설정 가능한 FPS ✅
6. **알림 발송**: 우선순위 기반, 시간 윈도우로 중복 방지 ✅

**확인이 필요한 사항**:
- [ ] 최대 동시 처리 카메라 수 (현재: 16개)
- [ ] 프레임 스트리밍 기본 FPS (추천: 5 FPS)
- [ ] 알림 중복 방지 시간 윈도우 (추천: 5분)
- [ ] 배치 저장 주기 (추천: 1초마다 또는 10개씩)

---

**다음 단계**: 위 사항들을 확인한 후 Sprint 1 구현을 시작하겠습니다.
