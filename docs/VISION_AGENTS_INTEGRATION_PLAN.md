# Vision-Agents 통합 계획서

**버전**: 1.0  
**작성일**: 2026-01-21  
**작성자**: AI Assistant

---

## 목차

1. [현재 프로젝트 분석](#1-현재-프로젝트-분석)
2. [Vision-Agents 분석](#2-vision-agents-분석)
3. [통합 가능성 평가](#3-통합-가능성-평가)
4. [통합 전략](#4-통합-전략)
5. [구현 계획](#5-구현-계획)
6. [리스크 및 대응](#6-리스크-및-대응)

---

## 1. 현재 프로젝트 분석

### 1.1 현재 아키텍처

```
AI_CCTV_final/
├── VAD (이상 탐지)
│   ├── MNAD (265 FPS, 82.4% AUC)
│   ├── MULDE, MemAE, STAE, STEAD
│   └── 프레임 단위 이상 점수 계산
│
├── VLM (상황 분석)
│   ├── Qwen2.5-VL-7B
│   ├── 이상 상황 유형 분류
│   └── 설명 및 권장 대응
│
├── Agent (자동 대응)
│   ├── Sequential/Hierarchical/Collaborative Flow
│   ├── Qwen3-8B 기반
│   └── 대응 계획 수립 및 실행
│
└── UI
    ├── CLI (Rich)
    ├── Streamlit Web UI
    └── React Web UI
```

### 1.2 현재 기능

**✅ 구현 완료:**
- 실시간 이상 탐지 (VAD)
- 상황 분석 (VLM)
- 자동 대응 (Agent)
- 이벤트 로깅 및 클립 저장
- 멀티 UI (CLI/Web/React)

**🚧 개발 예정:**
- 멀티 카메라 지원
- REST API 서버
- 데이터베이스 통합
- 알림 시스템
- 사용자 인증 및 권한 관리

### 1.3 현재 기술 스택

| 카테고리 | 기술 |
|---------|------|
| VAD | MNAD, MULDE, MemAE, STAE, STEAD |
| VLM | Qwen2.5-VL-7B (GGUF) |
| LLM | Qwen3-8B (GGUF) |
| 비디오 처리 | OpenCV |
| UI | Rich, Streamlit, React |
| 입력 소스 | 파일, RTSP, 웹캠 |

### 1.4 현재 성능

| 지표 | 값 |
|------|-----|
| VAD 처리 속도 | 265 FPS (MNAD) |
| VLM 분석 시간 | ~5초 |
| 전체 레이턴시 | ~5.2초 (이상 감지 시) |
| GPU 메모리 | 12GB (전체) |

---

## 2. Vision-Agents 분석

### 2.1 Vision-Agents Security Camera Example 특징

**핵심 기능:**
1. **얼굴 인식 및 추적**
   - 30분 시간 윈도우 내 방문자 추적
   - 얼굴 등록 및 재인식
   - 방문자 통계 관리

2. **패키지 감지 및 도난 감지**
   - YOLOv11 기반 패키지 감지
   - 3초 확인 로직 (거짓 경보 제거)
   - 도난 시 자동 대응

3. **이벤트 기반 아키텍처**
   - `PersonDetectedEvent`
   - `PackageDetectedEvent`
   - `PackageDisappearedEvent`
   - 이벤트 구독 및 핸들링

4. **음성 인터랙션**
   - STT (Deepgram)
   - TTS (ElevenLabs)
   - 음성 기반 질의응답

5. **Function Calling**
   - `get_visitor_count()`
   - `get_package_details()`
   - `remember_my_face()`
   - 자연어로 시스템 제어

6. **실시간 WebRTC 처리**
   - Stream Edge 네트워크
   - 저 지연시간 (<30ms)
   - 멀티플랫폼 SDK

### 2.2 Vision-Agents 기술 스택

| 카테고리 | 기술 |
|---------|------|
| LLM | Gemini 2.5 Flash, OpenAI GPT-4o |
| STT | Deepgram, Fast-Whisper |
| TTS | ElevenLabs, Deepgram Aura |
| 비디오 처리 | YOLO (Ultralytics), Roboflow |
| 엣지 네트워크 | GetStream Edge (WebRTC) |
| 이벤트 시스템 | 자체 이벤트 버스 |

### 2.3 Vision-Agents 성능

| 지표 | 값 |
|------|-----|
| 연결 속도 | 500ms |
| 오디오 지연 | <30ms |
| 비디오 지연 | <30ms |
| LLM 응답 | 100-200ms (Realtime API) |
| 전체 파이프라인 | 600-800ms |

---

## 3. 통합 가능성 평가

### 3.1 직접 적용 가능한 기능

#### ✅ 높은 적용 가능성 (즉시 적용 가능)

1. **이벤트 기반 아키텍처**
   - 현재: 폴링 기반, 콜백 함수
   - Vision-Agents: 이벤트 버스 시스템
   - **적용 가능성**: ⭐⭐⭐⭐⭐ (100%)
   - **난이도**: 중간
   - **예상 효과**: 코드 구조 개선, 확장성 향상

2. **Function Calling 시스템**
   - 현재: Agent가 직접 LLM 호출
   - Vision-Agents: Function Calling으로 시스템 제어
   - **적용 가능성**: ⭐⭐⭐⭐⭐ (100%)
   - **난이도**: 낮음
   - **예상 효과**: 자연어 인터페이스, 사용자 경험 향상

3. **얼굴 인식 및 추적**
   - 현재: 없음
   - Vision-Agents: 30분 윈도우 추적
   - **적용 가능성**: ⭐⭐⭐⭐⭐ (100%)
   - **난이도**: 중간
   - **예상 효과**: 새로운 기능 추가

4. **패키지 감지 및 도난 감지**
   - 현재: 일반적인 이상 탐지만
   - Vision-Agents: 특정 객체(패키지) 감지 및 추적
   - **적용 가능성**: ⭐⭐⭐⭐ (80%)
   - **난이도**: 중간
   - **예상 효과**: 구체적인 위협 감지

#### ⚠️ 조건부 적용 가능

5. **음성 인터랙션 (STT/TTS)**
   - 현재: 없음
   - Vision-Agents: Deepgram STT + ElevenLabs TTS
   - **적용 가능성**: ⭐⭐⭐ (60%)
   - **난이도**: 낮음
   - **조건**: 음성 인터랙션 필요 여부 확인 필요
   - **예상 효과**: 사용자 경험 향상

6. **실시간 WebRTC 처리**
   - 현재: OpenCV 기반 파일/RTSP 처리
   - Vision-Agents: Stream Edge (WebRTC)
   - **적용 가능성**: ⭐⭐ (40%)
   - **난이도**: 높음
   - **조건**: GetStream 계정 및 인프라 필요
   - **예상 효과**: 저 지연시간, 멀티플랫폼 지원

#### ❌ 적용 어려움

7. **Vision-Agents Agent 클래스 직접 사용**
   - 현재: 자체 Agent 시스템 (Qwen3-8B)
   - Vision-Agents: Agent 클래스 (Gemini/OpenAI)
   - **적용 가능성**: ⭐ (20%)
   - **이유**: 아키텍처 차이, 의존성 충돌 가능성
   - **대안**: 패턴 및 아이디어만 참고

### 3.2 통합 우선순위

| 우선순위 | 기능 | 적용 가능성 | 예상 효과 | 난이도 |
|---------|------|-----------|----------|--------|
| **P0** | 이벤트 기반 아키텍처 | ⭐⭐⭐⭐⭐ | 높음 | 중간 |
| **P0** | Function Calling | ⭐⭐⭐⭐⭐ | 높음 | 낮음 |
| **P1** | 얼굴 인식 및 추적 | ⭐⭐⭐⭐⭐ | 높음 | 중간 |
| **P1** | 패키지 감지 | ⭐⭐⭐⭐ | 중간 | 중간 |
| **P2** | 음성 인터랙션 | ⭐⭐⭐ | 중간 | 낮음 |
| **P3** | WebRTC 실시간 처리 | ⭐⭐ | 낮음 | 높음 |

---

## 4. 통합 전략

### 4.1 전략 원칙

1. **점진적 통합**: 기존 시스템을 유지하면서 단계적으로 개선
2. **패턴 참고**: Vision-Agents의 아키텍처 패턴을 참고하되, 직접 의존성은 최소화
3. **호환성 유지**: 기존 VAD/VLM/Agent 시스템과의 호환성 보장
4. **선택적 적용**: 필요한 기능만 선별적으로 적용

### 4.2 통합 접근 방식

#### 방식 A: 하이브리드 통합 (권장)

```
현재 시스템 (VAD/VLM/Agent)
    +
Vision-Agents 패턴 (이벤트/Function Calling)
    =
개선된 하이브리드 시스템
```

**장점:**
- 기존 코드 재사용
- 점진적 마이그레이션 가능
- 의존성 최소화

**단점:**
- 두 시스템 병행 관리 필요
- 일부 중복 코드 가능

#### 방식 B: 완전 마이그레이션 (비권장)

```
Vision-Agents Agent 클래스로 완전 교체
```

**장점:**
- 단일 아키텍처
- Vision-Agents 생태계 활용

**단점:**
- 대규모 리팩토링 필요
- 기존 VAD/VLM 시스템 재구현 필요
- 의존성 증가
- 리스크 높음

### 4.3 선택된 전략: **하이브리드 통합 (방식 A)**

---

## 5. 구현 계획

### 5.1 Phase 1: 이벤트 시스템 도입 (1-2주)

**목표**: 이벤트 기반 아키텍처로 전환

**작업:**
1. 이벤트 버스 시스템 구현
   - `EventBus` 클래스 생성
   - 이벤트 타입 정의
   - 구독/발행 메커니즘

2. 기존 콜백을 이벤트로 전환
   - `on_anomaly_callback` → `AnomalyDetectedEvent`
   - `on_frame_callback` → `FrameProcessedEvent`
   - `on_stats_callback` → `StatsUpdatedEvent`

3. 이벤트 핸들러 구현
   - VAD 이벤트 핸들러
   - VLM 이벤트 핸들러
   - Agent 이벤트 핸들러

**예상 결과:**
- 코드 구조 개선
- 확장성 향상
- 테스트 용이성 증가

### 5.2 Phase 2: Function Calling 도입 (1주)

**목표**: 자연어로 시스템 제어 가능

**작업:**
1. Function Calling 인프라 구현
   - 함수 등록 시스템
   - LLM과의 통합
   - 함수 실행 엔진

2. 핵심 함수 구현
   - `get_system_status()`: 시스템 상태 조회
   - `get_recent_events(limit)`: 최근 이벤트 조회
   - `get_anomaly_statistics()`: 이상 탐지 통계
   - `update_vad_threshold(value)`: VAD 임계값 변경
   - `enable_vlm(enabled)`: VLM 활성화/비활성화

3. Agent와 통합
   - 기존 Agent Flow에 Function Calling 추가
   - 자연어 질의 처리

**예상 결과:**
- 자연어 인터페이스 제공
- 사용자 경험 향상
- 시스템 제어 자동화

### 5.3 Phase 3: 패키지 감지 기능 추가 (2주)

**목표**: 특정 객체(패키지) 감지 및 도난 감지

**작업:**
1. YOLO 기반 객체 감지 통합
   - YOLO v12 nano 사용
   - 패키지 클래스 감지 (COCO 클래스 활용)
   - 커스텀 학습 불필요

2. 패키지 추적 시스템
   - 패키지 ID 관리
   - 위치 추적
   - 시간 윈도우 관리

3. 도난 감지 로직
   - 3초 확인 로직
   - 거짓 경보 제거
   - 도난 이벤트 생성

4. 이벤트 통합
   - `PackageDetectedEvent`
   - `PackageDisappearedEvent`
   - `TheftDetectedEvent`

5. Function Calling 함수 추가
   - `get_package_count()`: 패키지 통계
   - `get_package_details()`: 패키지 상세 정보
   - `get_activity_log(limit)`: 활동 로그

**예상 결과:**
- 구체적인 위협 감지
- 도난 방지 기능
- 증거 수집

### 5.4 Phase 4: 데이터베이스 통합 (1주)

**목표**: SQLite 데이터베이스로 이벤트 및 패키지 이력 저장

**작업:**
1. SQLite 스키마 설계
   - events 테이블
   - packages 테이블
   - 인덱스 생성

2. DatabaseManager 구현
   - 이벤트 저장
   - 패키지 저장/업데이트
   - 조회 쿼리

3. EventLogger와 통합
   - 이벤트 자동 저장
   - Function Calling 함수에서 조회

**예상 결과:**
- 이벤트 이력 관리
- 패키지 이력 관리
- 통계 조회 가능

### 5.5 Phase 5: 음성 인터랙션 (선택, 1-2주)

**목표**: 음성 기반 질의응답

**작업:**
1. STT 통합
   - Deepgram 또는 Fast-Whisper
   - 실시간 음성 인식

2. TTS 통합
   - ElevenLabs 또는 Kokoro
   - 음성 응답 생성

3. 음성 인터페이스 구현
   - 음성 입력 처리
   - Function Calling 연동
   - 음성 응답 출력

**예상 결과:**
- 음성 기반 제어
- 접근성 향상
- 사용자 경험 개선

### 5.6 Phase 6: WebRTC 실시간 처리 (선택, 3-4주)

**참고**: GetStream 무료 티어 제공
- $100/월 크레딧
- 66,000분 HD 무료
- Makers 프로그램: <5명 팀, <$10k 월 수익이면 무료

**목표**: 저 지연시간 실시간 처리

**작업:**
1. GetStream Edge 통합
   - 계정 생성 및 설정
   - Edge 네트워크 연결

2. WebRTC 스트리밍
   - 비디오 스트림 전송
   - 실시간 처리 파이프라인

3. 멀티플랫폼 SDK 연동
   - React, iOS, Android 등

**예상 결과:**
- 저 지연시간 (<30ms)
- 멀티플랫폼 지원
- 확장성 향상

**주의사항:**
- GetStream 계정 및 비용 필요
- 인프라 변경 필요
- 높은 복잡도

---

## 6. 리스크 및 대응

### 6.1 기술적 리스크

| 리스크 | 영향도 | 확률 | 대응 방안 |
|--------|--------|------|----------|
| 기존 시스템과의 호환성 문제 | 높음 | 중간 | 점진적 통합, 충분한 테스트 |
| 성능 저하 | 중간 | 낮음 | 벤치마크 테스트, 최적화 |
| 의존성 충돌 | 중간 | 중간 | 가상 환경 분리, 의존성 관리 |
| 메모리 사용량 증가 | 중간 | 중간 | 리소스 모니터링, 최적화 |

### 6.2 일정 리스크

| 리스크 | 영향도 | 확률 | 대응 방안 |
|--------|--------|------|----------|
| 일정 지연 | 중간 | 중간 | 단계별 구현, 우선순위 조정 |
| 범위 확장 | 높음 | 중간 | 명확한 범위 정의, 변경 관리 |

### 6.3 비즈니스 리스크

| 리스크 | 영향도 | 확률 | 대응 방안 |
|--------|--------|------|----------|
| GetStream 비용 | 낮음 | 높음 | WebRTC는 선택 사항, 무료 대안 검토 |
| API 키 관리 | 낮음 | 중간 | 환경 변수 관리, 보안 강화 |

---

## 7. 성공 지표

### 7.1 기술적 지표

- 이벤트 처리 지연시간 < 10ms
- Function Calling 응답 시간 < 2초
- 얼굴 인식 정확도 > 95%
- 패키지 감지 정확도 > 90%

### 7.2 기능적 지표

- 이벤트 기반 아키텍처 적용 완료
- Function Calling 함수 10개 이상 구현
- 얼굴 인식 및 추적 기능 동작
- 패키지 감지 및 도난 감지 기능 동작

### 7.3 사용자 경험 지표

- 자연어 질의 응답 성공률 > 80%
- 음성 인터랙션 응답 시간 < 3초 (선택)
- 시스템 제어 자동화율 > 70%

---

## 8. 다음 단계

1. **요구사항 정의서 작성** (이 문서와 함께)
2. **기술 검토 회의** (필요 시)
3. **Phase 1 시작**: 이벤트 시스템 도입
4. **단계별 검증 및 피드백**

---

*이 계획서는 프로젝트 진행에 따라 지속적으로 업데이트됩니다.*
